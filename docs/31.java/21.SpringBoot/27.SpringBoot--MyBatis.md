# SpringBoot之MyBatis

## MyBatis XML写法

### 批量操作优化

::: code-group

```xml [批量插入]

<insert id="batchInsert" parameterType="java.util.List">
  INSERT INTO user (username, email, create_time) VALUES
  <foreach collection="list" item="item" separator=",">
    (#{item.username}, #{item.email}, #{item.createTime})
  </foreach>
</insert>

```

```xml [批量更新]

<update id="batchUpdate" parameterType="java.util.List">
  <foreach collection="list" item="item" separator=";">
    UPDATE user
    SET username = #{item.username}, email = #{item.email}
    WHERE id = #{item.id}
  </foreach>
</update>

```

```xml [批量删除]

<delete id="batchDelete" parameterType="java.util.List">
  DELETE FROM user WHERE id IN
  <foreach collection="list" item="id" open="(" separator="," close=")">
    #{id}
  </foreach>
</delete>

```

:::

### 动态SQL

::: code-group

```xml [条件查询]
<!-- trim标签可以帮助我们优化生成的SQL语句,避免出现多余的AND或OR关键字 -->
<select id="findUsers" resultType="User">
  SELECT * FROM user
  <trim prefix="WHERE" prefixOverrides="AND |OR ">
    <!-- concat模糊查询 -->
    <if test="username != null and username != ''">
      AND username LIKE CONCAT('%', #{username}, '%')
    </if>
    <if test="email != null and email != ''">
      AND email = #{email}
    </if>
    <!-- 开始时间 >= 传入时间的 00:00:00 -->
    <if test="timeStart != null">
      AND <![CDATA[ time_start >= #{condition.timeStart} + INTERVAL '0' HOUR ]]>
    </if>
    <!-- 结束时间 < 传入时间+1的 00:00:00 -->
    <if test="timeEnd != null">
      AND <![CDATA[ time_end < #{condition.timeEnd} + INTERVAL '1' DAY ]]>
    </if>
    <!-- 班级id in查询 -->
    <if test="ids != null and ids.size() > 0">
      AND class_id IN
      <foreach collection="ids" item="id" open="(" separator="," close=")">#{id}</foreach>
    </if>
  </trim>
</select>

```

```xml [条件分支]

<select id="findUsersByCondition" resultType="User">
  SELECT * FROM user
  <where>
    <choose>
      <when test="searchType == 'username'">
        AND username LIKE CONCAT('%', #{keyword}, '%')
      </when>
      <when test="searchType == 'email'">
        AND email LIKE CONCAT('%', #{keyword}, '%')
      </when>
      <otherwise>
        AND (username LIKE CONCAT('%', #{keyword}, '%') OR email LIKE CONCAT('%', #{keyword}, '%'))
      </otherwise>
    </choose>
  </where>
</select>

```

```xml [自动生成主键]
<!--在插入操作中,我们经常需要获取数据库自动生成的主键。MyBatis提供了<selectKey>标签来实现这一功能。-->
<insert id="insertUser" parameterType="User" useGeneratedKeys="true" keyProperty="id">
  <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
    SELECT 2531020
  </selectKey>
  INSERT INTO user (username, email, create_time)
  VALUES (#{username}, #{email}, #{createTime})
</insert>

```

:::

### 注解写法

::: code-group

```java [UserMapper]

@Mapper
public interface UserMapper {
  @Select("SELECT * FROM user")
  List<User> findAll();

  /**
   * 通过id查询用户的全部信息
   * @param id 用户id
   * @return 用户信息模型
   */
  @Select({"select * from user where id = #{id}"})
  @Results(id = "studentMap", value = {
    @Result(column = "id", property = "id", id = true),
    @Result(column = "username", property = "username"),
    @Result(column = "name", property = "name"),
    @Result(property = "roleList", javaType = List.class, column = "id", many = @Many(select = "top.haijunit.sample.mapper.RoleMapper.getRoleListById"))
  })
  UserVO getUserById(@Param("id") Integer id);
}

```

```java [RoleMapper]

@Mapper
public interface RoleMapper {
  @Select("SELECT * FROM role WHERE roleName = #{roleName}")
  Role findByUsername(String roleName);

  @Select("SELECT * FROM role WHERE id IN (SELECT role_id FROM user_role_con WHERE user_id = #{id})")
  List<Role> getRoleListById(@Param("id") Integer id);
}
```

```java [动态 SQL]
import org.apache.ibatis.annotations.SelectProvider;
import org.apache.ibatis.builder.annotation.ProviderContext;

import java.util.Map;

@Mapper
public interface UserMapper extends BaseMapper<User> {

  @SelectProvider(type = SqlProvider.class, method = "findByCondition")
  List<User> findByCondition(Map<String, Object> conditions);

  class SqlProvider {
    public String findByCondition(Map<String, Object> params, ProviderContext context) {
      StringBuilder sql = new StringBuilder("SELECT * FROM user WHERE 1=1");
      if (params.get("username") != null) {
        sql.append(" AND username = #{username}");
      }
      if (params.get("email") != null) {
        sql.append(" AND email = #{email}");
      }
      return sql.toString();
    }
  }
}

```

:::

### Wrapper查询

::: code-group

```java [service]

@Service
@RequiredArgsConstructor
public class UserService {
  private final UserMapper userMapper;

  public List<User> findUsers() {
    QueryWrapper<User> queryWrapper = new QueryWrapper<>();
    queryWrapper.like("username", "张");
    queryWrapper.lamba().eq(User::getStatus, 1);
    return userMapper.findUsers(wrapper);
  }
}
```

```java [Mapper]

@Mapper
public interface UserMapper {
  @Select("SELECT * FROM user")
  List<User> findUsers(@Param(Constants.WRAPPER) Wrapper<User> wrapper);
}
```

```xml [Mapper]

<select id="findUsers" resultType="User">
  select * from user
  <where>
    <if test="ew.sqlSegment != null ">
      ${ew.sqlSegment}
    </if>
  </where>
</select>
```

:::
