# 认证授权

## 目的

- 1、支持系统账密登录。
- 2、支持邮箱登录。
- 3、支持短信登录。
- 4、支持微信登录（OpenId）。
- 5、支持企业微信登录。
- 6、支持Github、Gitee登录。
- 7、支持第三方授权登录。

## 相关地址

- [Spring官方文档 Spring Authorization Server](https://github.com/spring-projects/spring-security/wiki)
- [Spring中文文档 spring-authorization-server](https://springdoc.cn/spring-authorization-server/)

## 认证流程

```mermaid
sequenceDiagram
    participant 客户端
    participant 资源服务器
    participant 授权服务器
    客户端 ->> 资源服务器: 输入网址访问资源
    资源服务器 -->> 资源服务器: 验证是否登录
    opt 登录流程
        资源服务器 ->> 授权服务器: 跳转到授权服务器client_id,redirect_uri,scope
        授权服务器 ->> 客户端: 登录或者授权
        客户端 ->> 授权服务器: 输入用户名密码或者同意授权
        授权服务器 ->> 资源服务器: 返回授权码，redirect_uri
        资源服务器 ->> 授权服务器: 携带授权码请求token
        授权服务器 ->> 资源服务器: 返回token
        资源服务器 -->> 资源服务器: 验证token通过
    end
    资源服务器 ->> 客户端: 返回资源
```

---

```mermaid
sequenceDiagram
    participant 用户
    participant 网站
    participant 网关
    participant Oauth2认证中心
    participant 业务服务
    用户 ->> 网站: 输入网址
    网站 ->> + 网关: 跳转到网关
    opt 登录认证
        网关 -->> 网关: 校验是否登录与鉴权
        网关 ->> + Oauth2认证中心: 网关发现未认证，跳转到认证中心
        Oauth2认证中心 ->> 用户: 返回用户授权登录界面
        用户 ->> Oauth2认证中心: 用户登录
        Oauth2认证中心 ->> - 网关: 返回授权码code
        网关 ->> 网站: 定向到业务服务
        网站 ->> 网关: 携带token正常调用接口
    end
    网关 -->> - 网关: 校验token与鉴权
    网关 ->> 业务服务: 转发到业务服务
    业务服务 ->> 网站: 返回相应资源
```

## 授权模式

### 授权码模式

```mermaid
sequenceDiagram
    participant 客户端
    participant 授权服务器
    participant 资源服务器
    客户端 ->> 授权服务器: 请求授权码
    授权服务器 -->> 客户端: 弹出登录界面
    客户端 ->> 授权服务器: 输入用户名密码
    授权服务器 ->> 授权服务器: 验证授权码，客户端
    授权服务器 -->> 客户端: 返回token,refresh_token
    客户端 ->> 资源服务器: 携带token请求资源
    资源服务器 ->> 授权服务器: 验证token
    授权服务器 ->> 授权服务器: 验证token有效性
    授权服务器 ->> 资源服务器: 通过验证，返回资源
    资源服务器 -->> 客户端: 返回资源
```

### 客户端凭证模式

```mermaid
sequenceDiagram
    participant 客户端
    participant 授权服务器
    participant 资源服务器
    客户端 ->> 授权服务器: 发送client_id,client_secret
    授权服务器 ->> 客户端: 返回token
    客户端 ->> 资源服务器: 携带token请求资源
    资源服务器 ->> 授权服务器: 验证token
    授权服务器 ->> 授权服务器: 验证token有效性
    授权服务器 ->> 资源服务器: 通过验证
    资源服务器 -->> 客户端: 返回资源
```

### 令牌刷新模式

```mermaid
sequenceDiagram
    participant 客户端
    participant 授权服务器
    客户端 ->> 授权服务器: 发送refresh_token
    授权服务器 ->> 客户端: 返回token
```

### 密码模式

```mermaid
sequenceDiagram
    participant 客户端
    participant 授权服务器
    participant 资源服务器
    客户端 ->> 授权服务器: 发送用户名密码
    授权服务器 ->> 客户端: 返回token
    客户端 ->> 资源服务器: 携带token请求资源
    资源服务器 ->> 授权服务器: 验证token
    授权服务器 ->> 授权服务器: 验证token有效性
    授权服务器 ->> 资源服务器: 通过验证
    资源服务器 -->> 客户端: 返回资源
```

## Api调用

```http request
###### 获取授权码
# client_id 客户端ID
# response_type 响应模式
# scope 授权范围(不清楚可以百度一下)
# redirect_uri 回调地址,code会通过这个地址返回

GET http://127.0.0.1:8084/oauth2/authorize?client_id=sas-client&response_type=code&scope=message.read+openid&redirect_uri=http://127.0.0.1:8084/test
Authorization: Basic c2FzLWNsaWVudDpzYXMtc2VjcmV0

### 使用授权码token
# grant_type 授权模式
# code 你的授权码
# redirect_uri 回调地址,请求code时所传参数

POST http://127.0.0.1:8084/oauth2/token
Content-Type: application/x-www-form-urlencoded
Authorization: Basic c2FzLWNsaWVudDpzYXMtc2VjcmV0

grant_type = authorization_code &
code = {code} &
redirect_uri = http://127.0.0.1:8084/test

###### 账号密码获取token
# grant_type 授权模式
# username 账号
# password 密码
# scope 授权范围(不清楚可以百度一下)

POST http://127.0.0.1:8084/oauth2/token
Content-Type: application/x-www-form-urlencoded
Authorization: Basic c2FzLWNsaWVudDpzYXMtc2VjcmV0

grant_type = password &
username = {username} &
password = {password}

###### 客户端获取token
# grant_type 授权模式

POST http://127.0.0.1:8084/oauth2/token
Content-Type: application/x-www-form-urlencoded
Authorization: Basic c2FzLWNsaWVudDpzYXMtc2VjcmV0

grant_type = client_credentials

###### 刷新token
# grant_type 授权模式
# refresh_token refresh_token

POST http://127.0.0.1:8084/oauth2/token
Content-Type: application/x-www-form-urlencoded
Authorization: Basic c2FzLWNsaWVudDpzYXMtc2VjcmV0

grant_type = refresh_token &
refresh_token = {refresh_token}
```

## 验证码

```java
// 验证码流程：生成 -> 存储 -> 发送 -> 校验 -> 删除
// 存储：
// 验证：
// 类型：
```

```mermaid
classDiagram
    direction BT
    class AbstractCaptchaRepository {
        + AbstractCaptchaRepository(CaptchaValidateProperties)
        + getCaptchaCacheKey(ServletWebRequest, CaptchaType) String
    }
    class CaptchaRepository {
        <<Interface>>
        + remove(ServletWebRequest, CaptchaType) void
        + get(ServletWebRequest, CaptchaType) BasicCaptcha
        + save(ServletWebRequest, BasicCaptcha) void
    }
    class RedisCaptchaRepository {
        + RedisCaptchaRepository(RedisTemplate~Object, BasicCaptcha~, CaptchaValidateProperties)
        + get(ServletWebRequest, CaptchaType) BasicCaptcha
        + save(ServletWebRequest, BasicCaptcha) void
        + remove(ServletWebRequest, CaptchaType) void
    }
    class SessionCaptchaRepository {
        + SessionCaptchaRepository(CaptchaValidateProperties)
        + remove(ServletWebRequest, CaptchaType) void
        + save(ServletWebRequest, BasicCaptcha) void
        + get(ServletWebRequest, CaptchaType) BasicCaptcha
    }

    AbstractCaptchaRepository ..> CaptchaRepository
    RedisCaptchaRepository --> AbstractCaptchaRepository
    SessionCaptchaRepository --> AbstractCaptchaRepository

```
