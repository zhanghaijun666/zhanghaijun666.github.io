---
title: springboot+bizlogæ—¥å¿—
date: 2022-03-08 20:08:00
category: 
  - é›†æˆé…ç½®
  - SpringBoot
tag: 
  - SpringBoot
---

> Springboot-æ³¨è§£-é€šç”¨æ“ä½œæ—¥å¿—ç»„ä»¶
>
> æ­¤ç»„ä»¶è§£å†³çš„é—®é¢˜æ˜¯ï¼š ã€Œè°ã€åœ¨ã€Œä»€ä¹ˆæ—¶é—´ã€å¯¹ã€Œä»€ä¹ˆã€åšäº†ã€Œä»€ä¹ˆäº‹ã€
>
> githubåœ°å€ï¼š<https://github.com/mouzt/mzt-biz-log>

<!-- more -->
[[toc]]

## maven ä¾èµ–æ·»åŠ  SDK ä¾èµ–

```xml
<dependency>
    <groupId>io.github.mouzt</groupId>
    <artifactId>bizlog-sdk</artifactId>
    <version>1.0.1</version>
</dependency>
```

## æ·»åŠ  @EnableLogRecord æ³¨è§£

tenant æ˜¯ä»£è¡¨ç§Ÿæˆ·çš„æ ‡è¯†ï¼Œä¸€èˆ¬ä¸€ä¸ªæœåŠ¡æˆ–è€…ä¸€ä¸ªä¸šåŠ¡ä¸‹çš„å¤šä¸ªæœåŠ¡éƒ½å†™æ­»ä¸€ä¸ª tenant å°±å¯ä»¥

```java
@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)
@EnableTransactionManagement
@EnableLogRecord(tenant = "com.mzt.test")
public class Main {

    public static void main(String[] args) {
        SpringApplication.run(Main.class, args);
    }
}
```

## æ—¥å¿—åŸ‹ç‚¹

### 1. æ™®é€šçš„è®°å½•æ—¥å¿—

```java {8-12}
/*
* pefixï¼šæ˜¯æ‹¼æ¥åœ¨ bizNo ä¸Šä½œä¸º log çš„ä¸€ä¸ªæ ‡è¯†ã€‚é¿å… bizNo éƒ½ä¸ºæ•´æ•° ID çš„æ—¶å€™å’Œå…¶ä»–çš„ä¸šåŠ¡ä¸­çš„ ID é‡å¤ã€‚æ¯”å¦‚è®¢å• IDã€ç”¨æˆ· ID ç­‰
* bizNoï¼šå°±æ˜¯ä¸šåŠ¡çš„ IDï¼Œæ¯”å¦‚è®¢å•IDï¼Œæˆ‘ä»¬æŸ¥è¯¢çš„æ—¶å€™å¯ä»¥æ ¹æ® bizNo æŸ¥è¯¢å’Œå®ƒç›¸å…³çš„æ“ä½œæ—¥å¿—
* successï¼šæ–¹æ³•è°ƒç”¨æˆåŠŸåæŠŠ success è®°å½•åœ¨æ—¥å¿—çš„å†…å®¹ä¸­
*
* SpEL è¡¨è¾¾å¼ï¼šå…¶ä¸­ç”¨åŒå¤§æ‹¬å·åŒ…å›´èµ·æ¥çš„ï¼ˆä¾‹å¦‚ï¼š{{#order.purchaseName}}ï¼‰#order.purchaseName æ˜¯ SpELè¡¨è¾¾å¼ã€‚Springä¸­æ”¯æŒçš„å®ƒéƒ½æ”¯æŒçš„ã€‚
*/
@LogRecordAnnotation(
    success = "{{#order.purchaseName}}ä¸‹äº†ä¸€ä¸ªè®¢å•,è´­ä¹°å•†å“ã€Œ{{#order.productName}}ã€,ä¸‹å•ç»“æœ:{{#_ret}}",
    prefix = LogRecordType.ORDER,
    bizNo = "{{#order.orderNo}}"
)
public boolean createOrder(Order order) {
    log.info("ã€åˆ›å»ºè®¢å•ã€‘orderNo={}", order.getOrderNo());
    // db insert order
    return true;
}
// æ­¤æ—¶ä¼šæ‰“å°æ“ä½œæ—¥å¿— "å¼ ä¸‰ä¸‹äº†ä¸€ä¸ªè®¢å•,è´­ä¹°å•†å“ã€Œè¶…å€¼ä¼˜æƒ çº¢çƒ§è‚‰å¥—é¤ã€,ä¸‹å•ç»“æœ:true"
```

### 2. æœŸæœ›è®°å½•å¤±è´¥çš„æ—¥å¿—, å¦‚æœæŠ›å‡ºå¼‚å¸¸åˆ™è®°å½• fail çš„æ—¥å¿—ï¼Œæ²¡æœ‰æŠ›å‡ºè®°å½• success çš„æ—¥å¿—

```java {3}
// å…¶ä¸­çš„ #_errorMsg æ˜¯å–çš„æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åçš„å¼‚å¸¸çš„ errorMessageã€‚
@LogRecordAnnotation(
    fail = "åˆ›å»ºè®¢å•å¤±è´¥ï¼Œå¤±è´¥åŸå› ï¼šã€Œ{{#_errorMsg}}ã€",
    success = "{{#order.purchaseName}}ä¸‹äº†ä¸€ä¸ªè®¢å•,è´­ä¹°å•†å“ã€Œ{{#order.productName}}ã€,ä¸‹å•ç»“æœ:{{#_ret}}",
    prefix = LogRecordType.ORDER,
    bizNo = "{{#order.orderNo}}"
)
public boolean createOrder(Order order) {
    log.info("ã€åˆ›å»ºè®¢å•ã€‘orderNo={}", order.getOrderNo());
    // db insert order
    return true;
}
```

### 3. æ—¥å¿—æ”¯æŒç§ç±»

å¯¹æ—¥å¿—åšåˆ†ç±»ï¼ŒæŸ¥è¯¢æ–¹ä¾¿ï¼Œæ”¯æŒæ›´å¤šçš„ä¸šåŠ¡ã€‚

```java {5}
@LogRecordAnnotation(
    fail = "åˆ›å»ºè®¢å•å¤±è´¥ï¼Œå¤±è´¥åŸå› ï¼šã€Œ{{#_errorMsg}}ã€",
    category = "MANAGER",
    success = "{{#order.purchaseName}}ä¸‹äº†ä¸€ä¸ªè®¢å•,è´­ä¹°å•†å“ã€Œ{{#order.productName}}ã€,ä¸‹å•ç»“æœ:{{#_ret}}",
    prefix = LogRecordType.ORDER,
    bizNo = "{{#order.orderNo}}"
)
public boolean createOrder(Order order) {
    log.info("ã€åˆ›å»ºè®¢å•ã€‘orderNo={}", order.getOrderNo());
    // db insert order
    return true;
}
```

### 4. æ”¯æŒè®°å½•æ“ä½œçš„è¯¦æƒ…æˆ–è€…é¢å¤–ä¿¡æ¯

å¦‚æœä¸€ä¸ªæ“ä½œä¿®æ”¹äº†å¾ˆå¤šå­—æ®µï¼Œä½†æ˜¯ success çš„æ—¥å¿—æ¨¡ç‰ˆé‡Œé¢é˜²æ­¢è¿‡é•¿ä¸èƒ½æŠŠä¿®æ”¹è¯¦æƒ…å…¨éƒ¨å±•ç¤ºå‡ºæ¥ï¼Œè¿™æ—¶å€™éœ€è¦æŠŠä¿®æ”¹çš„è¯¦æƒ…ä¿å­˜åˆ° detail å­—æ®µï¼Œ detail æ˜¯ä¸€ä¸ª String ï¼Œéœ€è¦è‡ªå·±åºåˆ—åŒ–ã€‚

```java {4}
@LogRecordAnnotation(
    fail = "åˆ›å»ºè®¢å•å¤±è´¥ï¼Œå¤±è´¥åŸå› ï¼šã€Œ{{#_errorMsg}}ã€",
    category = "MANAGER_VIEW",
    detail = "{{#order.toString()}}",
    success = "{{#order.purchaseName}}ä¸‹äº†ä¸€ä¸ªè®¢å•,è´­ä¹°å•†å“ã€Œ{{#order.productName}}ã€,ä¸‹å•ç»“æœ:{{#_ret}}",
    prefix = LogRecordType.ORDER,
    bizNo = "{{#order.orderNo}}"
)
public boolean createOrder(Order order) {
    log.info("ã€åˆ›å»ºè®¢å•ã€‘orderNo={}", order.getOrderNo());
    // db insert order
    return true;
}
```

### 5. å¦‚ä½•æŒ‡å®šæ“ä½œæ—¥å¿—çš„æ“ä½œäººæ˜¯ä»€ä¹ˆï¼Ÿæ¡†æ¶æä¾›äº†ä¸¤ç§æ–¹æ³•

ç¬¬ä¸€ç§ï¼šæ‰‹å·¥åœ¨ LogRecord çš„æ³¨è§£ä¸ŠæŒ‡å®šã€‚è¿™ç§éœ€è¦æ–¹æ³•å‚æ•°ä¸Šæœ‰ operator

```java {5}
// éœ€è¦æ–¹æ³•å‚æ•°ä¸Šæœ‰ operator å‚æ•°ï¼Œæˆ–è€…é€šè¿‡ SpEL è°ƒç”¨é™æ€æ–¹æ³•è·å–å½“å‰ç”¨æˆ·ã€‚
@LogRecordAnnotation(
    fail = "åˆ›å»ºè®¢å•å¤±è´¥ï¼Œå¤±è´¥åŸå› ï¼šã€Œ{{#_errorMsg}}ã€",
    category = "MANAGER_VIEW",
    detail = "{{#order.toString()}}",
    operator = "{{#currentUser}}",
    success = "{{#order.purchaseName}}ä¸‹äº†ä¸€ä¸ªè®¢å•,è´­ä¹°å•†å“ã€Œ{{#order.productName}}ã€,ä¸‹å•ç»“æœ:{{#_ret}}",
    prefix = LogRecordType.ORDER,
    bizNo = "{{#order.orderNo}}"
)
public boolean createOrder(Order order, String currentUser) {
    log.info("ã€åˆ›å»ºè®¢å•ã€‘orderNo={}", order.getOrderNo());
    // db insert order
    return true;
}
```

ç¬¬äºŒç§ï¼šé€šè¿‡é»˜è®¤å®ç°ç±»æ¥è‡ªåŠ¨çš„è·å–æ“ä½œäººï¼Œç”±äºåœ¨å¤§éƒ¨åˆ† web åº”ç”¨ä¸­å½“å‰çš„ç”¨æˆ·éƒ½æ˜¯ä¿å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„ï¼Œæ‰€ä»¥æ¯ä¸ªæ³¨è§£éƒ½åŠ ä¸€ä¸ª operator è·å–æ“ä½œäººæ˜¾å¾—æœ‰äº›é‡å¤åŠ³åŠ¨ï¼Œæ‰€ä»¥æä¾›äº†ä¸€ä¸ªæ‰©å±•æ¥å£æ¥è·å–æ“ä½œäºº æ¡†æ¶æä¾›äº†ä¸€ä¸ªæ‰©å±•æ¥å£ï¼Œä½¿ç”¨æ¡†æ¶çš„ä¸šåŠ¡å¯ä»¥ implements è¿™ä¸ªæ¥å£è‡ªå·±å®ç°è·å–å½“å‰ç”¨æˆ·çš„é€»è¾‘ï¼Œ å¯¹äºä½¿ç”¨ Springboot çš„åªéœ€è¦å®ç° IOperatorGetService æ¥å£ï¼Œç„¶åæŠŠè¿™ä¸ª Service ä½œä¸ºä¸€ä¸ªå•ä¾‹æ”¾åˆ° Spring çš„ä¸Šä¸‹æ–‡ä¸­ã€‚ä½¿ç”¨ Spring Mvc çš„å°±éœ€è¦è‡ªå·±æ‰‹å·¥è£…é…è¿™äº› bean äº†ã€‚

```java
@Configuration
public class LogRecordConfiguration {
    @Bean
    public IOperatorGetService operatorGetService() {
        return () -> Optional.of(OrgUserUtils.getCurrentUser())
                .map(a -> new OperatorDO(a.getMisId()))
                .orElseThrow(() -> new IllegalArgumentException("user is null"));
    }
}
//ä¹Ÿå¯ä»¥è¿™ä¹ˆæï¼š
@Service
public class DefaultOperatorGetServiceImpl implements IOperatorGetService {
    @Override
    public OperatorDO getUser() {
        OperatorDO operatorDO = new OperatorDO();
        operatorDO.setOperatorId("SYSTEM");
        return operatorDO;
    }
}
```

### 6. æ—¥å¿—æ–‡æ¡ˆè°ƒæ•´

```java
/*
å¯¹äºæ›´æ–°ç­‰æ–¹æ³•ï¼Œæ–¹æ³•çš„å‚æ•°ä¸Šå¤§éƒ¨åˆ†éƒ½æ˜¯è®¢å•IDã€æˆ–è€…äº§å“IDç­‰ï¼Œ æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼šæ—¥å¿—è®°å½•çš„successå†…å®¹æ˜¯ï¼šâ€œæ›´æ–°äº†è®¢å•{{#orderId}},æ›´æ–°å†…å®¹ä¸ºâ€¦â€ï¼Œè¿™ç§å¯¹äºè¿è¥æˆ–è€…äº§å“æ¥è¯´éš¾ä»¥ç†è§£ï¼Œæ‰€ä»¥å¼•å…¥äº†è‡ªå®šä¹‰å‡½æ•°çš„åŠŸèƒ½ã€‚ä½¿ç”¨æ–¹æ³•æ˜¯åœ¨åŸæ¥çš„å˜é‡çš„ä¸¤ä¸ªå¤§æ‹¬å·ä¹‹é—´åŠ ä¸€ä¸ªå‡½æ•°åç§° ä¾‹å¦‚ â€œ{ORDER{#orderId}}â€ å…¶ä¸­ ORDER æ˜¯ä¸€ä¸ªå‡½æ•°åç§°ã€‚åªæœ‰ä¸€ä¸ªå‡½æ•°åç§°æ˜¯ä¸å¤Ÿçš„,éœ€è¦æ·»åŠ è¿™ä¸ªå‡½æ•°çš„å®šä¹‰å’Œå®ç°ã€‚å¯ä»¥çœ‹ä¸‹é¢ä¾‹å­ è‡ªå®šä¹‰çš„å‡½æ•°éœ€è¦å®ç°æ¡†æ¶é‡Œé¢çš„IParseFunctionçš„æ¥å£ï¼Œéœ€è¦å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼š
functionName() æ–¹æ³•å°±è¿”å›æ³¨è§£ä¸Šé¢çš„å‡½æ•°åï¼›
apply()å‡½æ•°å‚æ•°æ˜¯ "{ORDER{#orderId}}"ä¸­SpELè§£æçš„#orderIdçš„å€¼ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªæ•°å­—1223110ï¼Œæ¥ä¸‹æ¥åªéœ€è¦åœ¨å®ç°çš„ç±»ä¸­æŠŠ ID è½¬æ¢ä¸ºå¯è¯»æ‡‚çš„å­—ç¬¦ä¸²å°±å¯ä»¥äº†ï¼Œ ä¸€èˆ¬ä¸ºäº†æ–¹ä¾¿æ’æŸ¥é—®é¢˜éœ€è¦æŠŠåç§°å’ŒIDéƒ½å±•ç¤ºå‡ºæ¥ï¼Œä¾‹å¦‚ï¼š"è®¢å•åç§°ï¼ˆIDï¼‰"çš„å½¢å¼ã€‚
è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼šåŠ äº†è‡ªå®šä¹‰å‡½æ•°åï¼Œæ¡†æ¶æ€ä¹ˆèƒ½è°ƒç”¨åˆ°å‘¢ï¼Ÿç­”ï¼šå¯¹äºSpring bootåº”ç”¨å¾ˆç®€å•ï¼Œåªéœ€è¦æŠŠå®ƒæš´éœ²åœ¨Springçš„ä¸Šä¸‹æ–‡ä¸­å°±å¯ä»¥äº†ï¼Œå¯ä»¥åŠ ä¸ŠSpringçš„ @Component æˆ–è€… @Service å¾ˆæ–¹ä¾¿ğŸ˜„ã€‚Spring mvc åº”ç”¨éœ€è¦è‡ªå·±è£…é… Beanã€‚
*/
// æ²¡æœ‰ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°
@LogRecordAnnotation(
    success = "æ›´æ–°äº†è®¢å•{{#orderId}},æ›´æ–°å†…å®¹ä¸º....",
    prefix = LogRecordType.ORDER,
    bizNo = "{{#order.orderNo}}",
    detail = "{{#order.toString()}}"
)
public boolean update(Long orderId, Order order) {
    return false;
}

//ä½¿ç”¨äº†è‡ªå®šä¹‰å‡½æ•°ï¼Œä¸»è¦æ˜¯åœ¨ {{#orderId}} çš„å¤§æ‹¬å·ä¸­é—´åŠ äº† functionName
@LogRecordAnnotation(
    success = "æ›´æ–°äº†è®¢å•ORDER{#orderId}},æ›´æ–°å†…å®¹ä¸º...",
    prefix = LogRecordType.ORDER,
    bizNo = "{{#order.orderNo}}",
    detail = "{{#order.toString()}}"
)
public boolean update(Long orderId, Order order) {
    return false;
}

// è¿˜éœ€è¦åŠ ä¸Šå‡½æ•°çš„å®ç°
@Component
public class OrderParseFunction implements IParseFunction {
    @Resource
    @Lazy //ä¸ºäº†é¿å…ç±»åŠ è½½é¡ºåºçš„é—®é¢˜ æœ€å¥½ä¸ºLazyï¼Œæ²¡æœ‰é—®é¢˜ä¹Ÿå¯ä»¥ä¸åŠ 
    private OrderQueryService orderQueryService;

    @Override
    public String functionName() {
        //  å‡½æ•°åç§°ä¸º ORDER
        return "ORDER";
    }

    @Override
    //è¿™é‡Œçš„ value å¯ä»¥å§ Order çš„JSONå¯¹è±¡çš„ä¼ é€’è¿‡æ¥ï¼Œç„¶ååè§£ææ‹¼æ¥ä¸€ä¸ªå®šåˆ¶çš„æ“ä½œæ—¥å¿—å†…å®¹
    public String apply(String value) {
        if(StringUtils.isEmpty(value)){
            return value;
        }
        Order order = orderQueryService.queryOrder(Long.parseLong(value));
        //æŠŠè®¢å•äº§å“åç§°åŠ ä¸Šä¾¿äºç†è§£ï¼ŒåŠ ä¸Š ID ä¾¿äºæŸ¥é—®é¢˜
        return order.getProductName().concat("(").concat(value).concat(")");
    }
}
```

### 7. æ—¥å¿—æ–‡æ¡ˆè°ƒæ•´ ä½¿ç”¨ SpEL ä¸‰ç›®è¡¨è¾¾å¼

````java
@LogRecordAnnotation(prefix = LogRecordTypeConstant.CUSTOM_ATTRIBUTE, bizNo = "{{#businessLineId}}", success = "{{#disable ? 'åœç”¨' : 'å¯ç”¨'}}äº†è‡ªå®šä¹‰å±æ€§{ATTRIBUTE{#attributeId}}") public CustomAttributeVO disableAttribute(Long businessLineId, Long attributeId, boolean disable) { return xxx; } `
æ¡†æ¶çš„æ‰©å±•ç‚¹ï¼Œé‡å†™ OperatorGetServiceImpl é€šè¿‡ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·çš„æ‰©å±•ï¼Œä¾‹å­å¦‚ä¸‹
``` java
@Service
public class DefaultOperatorGetServiceImpl implements IOperatorGetService {

    @Override
    public Operator getUser() {
        return Optional.ofNullable(UserUtils.getUser())
                        .map(a -> new Operator(a.getName(), a.getLogin()))
                        .orElseThrow(()->new IllegalArgumentException("user is null"));

    }
}
````

ILogRecordService ä¿å­˜/æŸ¥è¯¢æ—¥å¿—çš„ä¾‹å­,ä½¿ç”¨è€…å¯ä»¥æ ¹æ®æ•°æ®é‡ä¿å­˜åˆ°åˆé€‚çš„å­˜å‚¨ä»‹è´¨ä¸Šï¼Œæ¯”å¦‚ä¿å­˜åœ¨æ•°æ®åº“/æˆ–è€… ESã€‚è‡ªå·±å®ç°ä¿å­˜å’Œåˆ é™¤å°±å¯ä»¥äº†

ä¹Ÿå¯ä»¥åªå®ç°æŸ¥è¯¢çš„æ¥å£ï¼Œæ¯•ç«Ÿå·²ç»ä¿å­˜åœ¨ä¸šåŠ¡çš„å­˜å‚¨ä¸Šäº†ï¼ŒæŸ¥è¯¢ä¸šåŠ¡å¯ä»¥è‡ªå·±å®ç°ï¼Œä¸èµ° ILogRecordService è¿™ä¸ªæ¥å£ï¼Œæ¯•ç«Ÿäº§å“ç»ç†ä¼šæä¸€äº›åƒå¥‡ç™¾æ€ªçš„æŸ¥è¯¢éœ€æ±‚ã€‚

```java
@Service
public class DbLogRecordServiceImpl implements ILogRecordService {

    @Resource
    private LogRecordMapper logRecordMapper;

    @Override
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void record(LogRecord logRecord) {
        log.info("ã€logRecordã€‘log={}", logRecord);
        LogRecordPO logRecordPO = LogRecordPO.toPo(logRecord);
        logRecordMapper.insert(logRecordPO);
    }

    @Override
    public List<LogRecord> queryLog(String bizKey, Collection<String> types) {
        return Lists.newArrayList();
    }

    @Override
    public PageDO<LogRecord> queryLogByBizNo(String bizNo, Collection<String> types, PageRequestDO pageRequestDO) {
        return logRecordMapper.selectByBizNoAndCategory(bizNo, types, pageRequestDO);
    }
}
```

IParseFunction è‡ªå®šä¹‰è½¬æ¢å‡½æ•°çš„æ¥å£ï¼Œå¯ä»¥å®ç° IParseFunction å®ç°å¯¹ LogRecord æ³¨è§£ä¸­ä½¿ç”¨çš„å‡½æ•°æ‰©å±• ä¾‹å­ï¼š

```java
@Component
public class UserParseFunction implements IParseFunction {
    private final Splitter splitter = Splitter.on(",").trimResults();

    @Resource
    @Lazy
    private UserQueryService userQueryService;

    @Override
    public String functionName() {
        return "USER";
    }

    @Override
    // 11,12 è¿”å› 11(å°æ˜)ï¼Œ12(å¼ ä¸‰)
    public String apply(String value) {
        if (StringUtils.isEmpty(value)) {
            return value;
        }
        List<String> userIds = Lists.newArrayList(splitter.split(value));
        List<User> misDOList = userQueryService.getUserList(userIds);
        Map<String, User> userMap = StreamUtil.extractMap(misDOList, User::getId);
        StringBuilder stringBuilder = new StringBuilder();
        for (String userId : userIds) {
            stringBuilder.append(userId);
            if (userMap.get(userId) != null) {
                stringBuilder.append("(").append(userMap.get(userId).getUsername()).append(")");
            }
            stringBuilder.append(",");
        }
        return stringBuilder.toString().replaceAll(",$", "");
    }
}
```
